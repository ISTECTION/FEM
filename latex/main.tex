\documentclass[12pt,a4paper]{article}
\usepackage[left=20mm,top=20mm,total={170mm,257mm}]{geometry}

\usepackage{styles/preamble}
\usepackage{minted}                 % Для вставок с кодом
\usepackage{xcolor}
\usepackage{mathtools}              % Для математических формул
\usepackage{amsmath}

\setmainfont[Scale=1.0]{Noto Sans}
\definecolor{LightGray}{gray}{0.9}  % Не используется
\usemintedstyle{vs}                 % Стиль кода пакета minted


% =================================================
% НАЧАЛО ДОКУМЕНТА
% =================================================

\begin{document}
\import{titlepage/}{title}

\section{Условие задачи}                % Условие задачи
\subsection*{Формулировка задачи}       % Формулировка задачи

МКЭ для двумерной краевой задачи для эллиптического уравнения в декартовой
системе координат. Базисные функции линейные на треугольниках. Краевые условия
всех ти-пов. Коэффициент   разложить по линейным базисным функциям.
Матрицу СЛАУ генери-ровать в разреженном строчном формате. Для решения
СЛАУ использовать МСГ или ЛОС с неполной факторизацией.

\subsection*{Постановка задачи}

Эллиптическая краевая задача для функции \textit{u} определяется дифференциальным
уравнением

\[ -div( \lambda grad u) + \gamma u = f \]

\noindent заданным в некоторой области $\Omega$ с границей
$S=S_1 \cup S_2 \cup S_3$ и краевыми условиями:

\[ u \vert_{S_1} = u_g \]
\[ \lambda \frac{\partial u}{\partial n} \bigg\vert_{S_2} = \theta \]
\[ \lambda \frac{\partial u}{\partial n} \bigg\vert_{S_3}
    + \beta(u \vert_{S_3} - u_{\beta}) = 0 \]

\noindent В декартовой системе координат {x,y} это уравнение может быть записано
в виде

\[ -\frac{\partial}{\partial x}
    \left( \lambda \frac{\partial u}{\partial x} \right)
    -\frac{\partial}{\partial y}
    \left( \lambda \frac{\partial u}{\partial y} \right)
    + \gamma u = f \]

\subsection*{Конечноэлементная дискретизация}

Так как для решения задачи используются линейные базисные
функции, то на каждом конечном элементе $\Omega_k$ -
треугольнике эти функции будут совпадать с функциями
$L_1(x,y), L_2(x,y), L_3(x,y)$, такими, что $L_1(x,y)$
равна единице в вершине $(x_1,y_1)$ и нулю во всех остальных
вершинах, $L_2(x,y)$ равна единице в вершине $(x_2,y_2)$
и нулю во всех остальных вершинах, $L_3(x,y)$ равна единице
в вершине $(x_3,y_3)$ и нулю во всех остальных вершинах.
Любая линейная на $\Omega_k$ функция представима в виде
линейной комбинации этих базисных линейных функций,
коэффициентами будут значения функции в каждой из вершин
треугольника $\Omega_k$. Таким образом, на каждом конечном
элементе нам понадобятся три узла – вершины треугольника.

\[ \psi_1 = L_1(x,y) \]
\[ \psi_2 = L_2(x,y) \]
\[ \psi_3 = L_3(x,y) \]
\newpage

\noindent Учитывая построение \textit{L-функций},
получаем следующие соотношения:

\begin{equation*}
    \begin{cases}
        L_1 + L_2 + L_3 = 1          \\
        L_1x_1 + L_2x_2 + L_3x_3 = x \\
        L_1y_1 + L_2y_2 + L_3y_3 = y
    \end{cases}
\end{equation*}

\noindent Т.e. имеем систему:
\renewcommand{\arraystretch}{1.25}
\begin{equation*}
    \begin{pmatrix}
        1   & 1   & 1   \\
        x_1 & x_2 & x_3 \\
        y_1 & y_2 & y_3
    \end{pmatrix}
    \cdot
    \begin{pmatrix}
        L_1 \\
        L_2 \\
        L_3
    \end{pmatrix}
    =
    \begin{pmatrix}
        1 \\
        x \\
        y
    \end{pmatrix}
\end{equation*}
\renewcommand{\arraystretch}{1.0}

\noindent Отсюда находим коэффициенты
линейных функций $L_1(x,y), L_2(x,y), L_3(x,y)$
\[ L_i = a_0^i + a_1^ix + a_2^iy, i = \overline{1,3} \]

\renewcommand{\arraystretch}{1.25}
\begin{equation*}
    \begin{pmatrix}
        \alpha_0^1 & \alpha_1^1 & \alpha_2^1 \\
        \alpha_0^2 & \alpha_1^2 & \alpha_2^2 \\
        \alpha_0^3 & \alpha_1^3 & \alpha_2^3
    \end{pmatrix}
    =
    D^{-1}
    =
    {\begin{pmatrix}
        1   & 1   & 1   \\
        x_1 & x_2 & x_3 \\
        y_1 & y_2 & y_3
    \end{pmatrix}}^{-1}
\end{equation*}
\renewcommand{\arraystretch}{1.0}

\renewcommand{\arraystretch}{1.25}
\begin{equation*}
    D^{-1} = \frac{1}{\vert det D \vert}
    \begin{pmatrix}
        x_2y_3-x_3y_2 & y_2-y_3 & x_3-x_2 \\
        x_3y_1-x_1y_3 & y_3-y_1 & x_1-x_3 \\
        x_1y_2-x_2y_1 & y_1-y_2 & x_2-x_1
    \end{pmatrix}
\end{equation*}
\renewcommand{\arraystretch}{1.0}

\subsection*{Переход к локальным матрицам}

Чтобы получить выражения для локальных
матриц жёсткости G и массы M каждого
конечного элемента $\Omega_K$, перейдём
к решению локальной задачи на каждом
конечном элементе. Полученное уравнение
для области $\Omega$ представим в виде
суммы интегралов по областям $\Omega_k$
без учёта краевых условий. Тогда на
каждом конечном элементе будем решать
локальную задачу построения матриц
жёсткости, массы и вектора правой части.

$$
\int \limits_{\Omega_k} \lambda
\left(
    \frac{\partial \psi_j}{\partial x}
    \frac{\partial \psi_i}{\partial x}
    +
    \frac{\partial \psi_j}{\partial y}
    \frac{\partial \psi_i}{\partial y}
\right) dxdy
+
\int \limits_{\Omega_k} \gamma \psi_j \psi_i dsdy
=
\int \limits_{\Omega_k} f \psi_i dxdy
$$

\noindent Локальная матрица будет представлять
собой сумму матриц жёсткости и массы и будет
иметь размерность $3 \times 3$ (по числу
узлов на конечном элементе)

\subsection*{Построение матрицы массы}

\begin{eqnarray*}
M_{ij} =
    \int \limits_{\Omega_m} \gamma Y_iY_j d\Omega_m =
    \Big \vert \gamma = Y_1\gamma_1
                      + Y_2\gamma_2
                      + Y_3\gamma_3
    \Big \vert
    =
    \int \limits_{\Omega_m}
        \left(
            Y_1\gamma_1
          + Y_2\gamma_2
          + Y_3\gamma_3
        \right) Y_i Y_j d \Omega_m = \\ =
    \gamma_1 \int \limits_{\Omega_m} Y_1 Y_i Y_j d \Omega_m +
    \gamma_2 \int \limits_{\Omega_m} Y_2 Y_i Y_j d \Omega_m +
    \gamma_3 \int \limits_{\Omega_m} Y_3 Y_i Y_j d \Omega_m = \\ =
    \gamma_1 \int \limits_{\Omega_m} L_1 L_i L_j d \Omega_m +
    \gamma_2 \int \limits_{\Omega_m} L_2 L_i L_j d \Omega_m +
    \gamma_3 \int \limits_{\Omega_m} L_3 L_i L_j d \Omega_m
\end{eqnarray*}

\subsection*{Построение матрицы жёсткости}

Рассмотрим первый член в выражении для k-го конечного
эдемента:

$$
\int \limits_{\Omega_k} \lambda
    \left(
        \frac{\partial \psi_j}{\partial x}
        \frac{\partial \psi_i}{\partial x}
        +
        \frac{\partial \psi_j}{\partial y}
        \frac{\partial \psi_i}{\partial y}
        dxdy
    \right)
$$

$$
B_{i,j}=(\alpha_1^i \alpha_1^j + \alpha_2^i \alpha_2^j)
    \frac{\big \vert det D \big \vert}{2}
    \hspace{15pt} i,j=\overline{0,2}
$$

\subsection*{Построение вектора правой части}

Рассмотрим правую часть выражения для k-го конечного элемента:

$$
\int \limits_{\Omega_k} f \psi_i dxdy
$$

\noindent представим $f$ в виде $f_1 L_1 + f_2 L_2 + f_3 L_3$, где
$f_i$ - значения в вершинах треугольника. Получим:

$$
\int \limits_{\Omega_k} f_q L_q L_i dxdy =
    f_q \int \limits_{\Omega_k} L_q L_i d \Omega_k
$$

\noindent Таким образом:
$$
G_i = \sum \limits_{q=1}^{3}
    f_q \int \limits_{\Omega_k} L_q L_i d\Omega_k
    \hspace{15pt} i=\overline{0,2}
$$

\subsection*{Сборка глобальной матрицы и глобального вектора}

При формировании глобальной матрицы из локальных,
полученных суммированием соответствующих матриц
массы и жесткости, учитываем соответствие локальной
и глобальной нумераций каждого конечного элемента.
Глобальная нумерация каждого конечного элемента
однозначно определяет позиции вклада его локальной м
атрицы в глобальную. Поэтому, зная глобальные
номера соответствующих узлов конечного элемента,
определяем и то, какие элементы глобальной матрицы
изменятся при учете текущего конечного элемента.
Аналогичным образом определяется вклад локального
вектора правой части в глобальный. При учете
текущего локального вектора изменятся те элементы
глобального вектора правой части, номера которых
совпадают с глобальными номерами узлов, присутствующих
в этом конечном элементе.

\subsection*{Учёт первых краевых условий}

Для учета первых краевых условий, в глобальной матрице
и глобальном векторе находим соответствующую глобальному
номеру краевого узла строку и зануляем всё кроме
диагонального элемента, которому присваиваем 1, а вместо
элемента с таким номером в векторе правой части - значение
краевого условия, заданное в исходной задаче.


\subsection*{Учёт вторых и трeтьих краевых условий}




\section{Текст программы}

\section{Тестирование}

\section{Выводы}

\begin{minted}[linenos,mathescape=true,baselinestretch=1.0]{c++}
#include "argparse/argparse.hpp"        /// $\frac{a+b}{2}$
#include "timer/cxxtimer.hpp"           /// $\frac{a+b}{2}$
#include "LOS/LOS.hpp"                  /// $\frac{a+b}{2}$
#include "FEM.hpp"

int main(int argc, char* argv[]) {
    using namespace ::Log;
    using ::std::chrono::milliseconds;

    argparse::ArgumentParser program("FEM", "1.0.0");
    program.add_argument("-i", "--input" ).required().help("path to input files" );
    program.add_argument("-o", "--output").required().help("path to output files");

    try {
        program.parse_args(argc, argv);

        cxxtimer::Timer timer(true);
        FEM fem      (program.get<std::string>("-i"));
        fem.writeFile(program.get<std::string>("-o"), 1E-14, 10000);
        LOS<double> l(program.get<std::string>("-o"));
        l.solve(Cond::HOLLESKY, true);
        timer.stop();

        l.printX();

        std::cout << '\n' << "Milliseconds: "
                << timer.count<milliseconds>() << '\n';
        fem.printAll();
        fem.printSparse();
    }
    catch(const std::runtime_error& err) {
        Logger::append(getLog("argc != 3 (FEM -i input -o output)"));
        std::cerr << err.what();
        std::cerr << program;
        std::exit(1);
    }
    return 0;
}
\end{minted}
\end{document}